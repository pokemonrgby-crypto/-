<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Zeta Lite – Gemini Streaming Chat (Single HTML)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind config for dark class strategy
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          boxShadow: {
            'soft': '0 8px 30px rgba(0,0,0,0.10)',
          },
          keyframes: {
            pop: { '0%': { transform:'scale(.98)', opacity:0 }, '100%': { transform:'scale(1)', opacity:1 } },
            slideIn: { '0%': { transform:'translateX(-10px)', opacity:0 }, '100%': { transform:'translateX(0)', opacity:1 } },
            fadeUp: { '0%': { transform:'translateY(6px)', opacity:0 }, '100%': { transform:'translateY(0)', opacity:1 } },
          },
          animation: {
            pop: 'pop .18s ease-out',
            slideIn: 'slideIn .18s ease-out',
            fadeUp: 'fadeUp .25s ease-out',
          }
        }
      }
    }
  </script>

  <!-- Icons: Heroicons (inline SVG used) -->

  <!-- Highlight.js (light/dark aware via CSS tweak) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" media="(prefers-color-scheme: light)">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" media="(prefers-color-scheme: dark)">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- Marked (final pass rendering after stream ends) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- KaTeX for LaTeX rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <style>
    /* App-level helpers */
    :root { color-scheme: light dark; }
    html, body { height: 100%; }
    .scroll-smooth { scroll-behavior: smooth; }
    .chat-scroll { overscroll-behavior: contain; }
    .msg-actions button { opacity: 0.0; transition: opacity .12s ease; }
    .msg:hover .msg-actions button { opacity: 1; }
    .msg .msg-actions button:focus { opacity: 1; }
    pre { position: relative; }
    .copy-btn {
      position: absolute; top: .5rem; right: .5rem;
      font-size: .75rem; padding: .2rem .5rem; border-radius:.5rem;
      background: rgba(0,0,0,.6); color: #fff; backdrop-filter: blur(3px);
    }
    .copy-btn.light { background: rgba(255,255,255,.9); color: #111; border: 1px solid rgba(0,0,0,.08); }
    .visually-hidden { position:absolute !important; clip: rect(1px,1px,1px,1px); padding:0 !important; border:0 !important; height:1px !important; width:1px !important; overflow:hidden; white-space:nowrap; }
    /* Prevent vertical text wrapping in tight spaces */
    .btn-label { white-space: nowrap; }
    /* Code block collapse/expand */
    .code-header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      background: rgba(0,0,0,0.05); 
      padding: 0.5rem 1rem; 
      border-bottom: 1px solid rgba(0,0,0,0.1);
      cursor: pointer;
    }
    .dark .code-header { background: rgba(255,255,255,0.05); border-bottom-color: rgba(255,255,255,0.1); }
    .code-collapsed { display: none; }
    /* Image preview */
    .img-preview-container { position: relative; display: inline-block; }
    .img-preview-remove { 
      position: absolute; 
      top: 0.25rem; 
      right: 0.25rem; 
      background: rgba(0,0,0,0.6); 
      color: white; 
      border-radius: 50%; 
      width: 24px; 
      height: 24px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      cursor: pointer; 
    }
    /* Pinned messages */
    #pinnedMessages { max-height: 200px; overflow-y: auto; }
    /* Formatting toolbar */
    .format-toolbar button { 
      padding: 0.25rem 0.5rem; 
      border-radius: 0.25rem; 
      font-size: 0.875rem;
      background: transparent;
      border: 1px solid currentColor;
      opacity: 0.7;
    }
    .format-toolbar button:hover { opacity: 1; background: rgba(0,0,0,0.05); }
    .dark .format-toolbar button:hover { background: rgba(255,255,255,0.05); }
  </style>
</head>

<body class="h-full bg-neutral-50 text-neutral-900 dark:bg-neutral-950 dark:text-neutral-50 selection:bg-emerald-300 selection:text-black">
  <!-- App Shell -->
  <div id="app" class="h-full flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-40 bg-white/80 dark:bg-neutral-900/70 backdrop-blur border-b border-neutral-200/70 dark:border-neutral-800">
      <div class="max-w-6xl mx-auto px-3 sm:px-4">
        <div class="flex items-center gap-2 py-2">
          <button id="btnOpenSidebar"
                  class="inline-flex items-center gap-2 rounded-2xl px-3 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors"
                  aria-label="사이드바 열기">
            <!-- Bars Icon -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="hidden sm:inline btn-label">메뉴</span>
          </button>
          <div class="flex-1 flex items-center gap-2">
            <div class="flex items-center gap-3">
              <div id="headerAvatar" class="w-8 h-8 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-white shadow-soft">
                <!-- robot placeholder -->
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                  <path d="M12 3v3M7 22h10a3 3 0 0 0 3-3v-7a5 5 0 0 0-5-5H9a5 5 0 0 0-5 5v7a3 3 0 0 0 3 3Z" stroke="white" stroke-width="2" stroke-linecap="round"/>
                  <circle cx="9.5" cy="12.5" r="1.25" fill="white"/>
                  <circle cx="14.5" cy="12.5" r="1.25" fill="white"/>
                </svg>
              </div>
              <h1 class="text-lg font-semibold tracking-tight">Zeta Chat <span class="text-neutral-500 dark:text-neutral-400 text-sm">for Gemini</span></h1>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <button id="btnSummary" class="inline-flex items-center gap-2 rounded-2xl px-3 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors"
                    title="대화 요약">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2M9 5a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2M9 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2m-6 9 2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span class="hidden sm:inline btn-label">요약</span>
            </button>

            <button id="btnExport" class="inline-flex items-center gap-2 rounded-2xl px-3 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors"
                    title="내보내기" aria-haspopup="menu" aria-expanded="false">
              <!-- Download Icon -->
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M12 3v10m0 0 3.5-3.5M12 13 8.5 9.5M4 21h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span class="hidden sm:inline btn-label">내보내기</span>
            </button>

            <button id="btnTheme" class="inline-flex items-center gap-2 rounded-2xl px-3 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors" aria-label="테마 전환">
              <!-- Sun/Moon swap -->
              <svg id="iconSun" class="block dark:hidden" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"/>
                <path d="M12 2v2m0 16v2m10-10h-2M4 12H2m15.5-7.5-1.5 1.5M8 20l-1.5 1.5M20 8l-1.5 1.5M8 3 6.5 4.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <svg id="iconMoon" class="hidden dark:block" width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span class="hidden sm:inline btn-label">테마</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar (drawer) -->
    <div id="sidebarBackdrop" class="fixed inset-0 z-40 bg-black/20 opacity-0 pointer-events-none transition-opacity"></div>
    <aside id="sidebar"
           class="fixed z-50 top-0 left-0 w-[88%] sm:w-[380px] max-w-[92vw] h-full bg-white dark:bg-neutral-900 border-r border-neutral-200 dark:border-neutral-800 shadow-xl -translate-x-full transition-transform">
      <div class="h-full flex flex-col">
        <div class="flex items-center justify-between px-4 py-3 border-b border-neutral-200 dark:border-neutral-800">
          <div class="flex items-center gap-3">
            <div id="sbAvatar" class="w-8 h-8 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-500 flex items-center justify-center text-white">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 3v3M7 22h10a3 3 0 0 0 3-3v-7a5 5 0 0 0-5-5H9a5 5 0 0 0-5 5v7a3 3 0 0 0 3 3Z" stroke="white" stroke-width="2" stroke-linecap="round"/>
                <circle cx="9.5" cy="12.5" r="1.25" fill="white"/>
                <circle cx="14.5" cy="12.5" r="1.25" fill="white"/>
              </svg>
            </div>
            <div>
              <div class="text-base font-semibold">설정 & 관리</div>
              <div class="text-xs text-neutral-500 dark:text-neutral-400">API 키 · 모델 · 캐릭터 · 대화</div>
            </div>
          </div>
          <button id="btnCloseSidebar" class="rounded-xl p-2 hover:bg-neutral-100 dark:hover:bg-neutral-800" aria-label="사이드바 닫기">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M18 6 6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          </button>
        </div>

        <div class="flex-1 overflow-y-auto">
          <!-- Sections -->
          <div class="p-4 space-y-6">
            <!-- API Key -->
            <section class="space-y-3">
              <h2 class="text-sm font-semibold uppercase tracking-wider text-neutral-500">API 설정</h2>
              <div class="space-y-2">
                <label class="text-sm font-medium block">Gemini API 키</label>
                <div class="flex gap-2">
                  <input id="inpApiKey" type="password" inputmode="text" autocomplete="off"
                         class="flex-1 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-2"
                         placeholder="AIza... (브라우저에 안전 저장)" />
                  <button id="btnSaveKey" class="rounded-xl px-3 py-2 bg-emerald-600 text-white hover:bg-emerald-700 btn-label">
                    저장 & 검증
                  </button>
                </div>
                <p id="apiKeyStatus" class="text-xs text-neutral-500">키 저장 후 검증합니다.</p>
              </div>

              <div class="space-y-2">
                <label class="text-sm font-medium block">AI 모델</label>
                <select id="selModel" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-2">
                  <option>gemini-2.0-flash</option>
                  <option>gemini-2.0-flash-lite</option>
                  <option>gemini-2.5-flash</option>
                  <option>gemini-2.5-flash-lite</option>
                </select>
              </div>

              <!-- Advanced API Parameters -->
              <div class="space-y-2">
                <label class="text-sm font-medium block">Temperature (창의성)</label>
                <div class="flex items-center gap-2">
                  <input id="sliderTemp" type="range" min="0" max="2" step="0.1" value="0.7" class="flex-1" />
                  <span id="tempValue" class="text-sm w-10">0.7</span>
                </div>
              </div>

              <div class="space-y-2">
                <label class="text-sm font-medium block">Top P</label>
                <div class="flex items-center gap-2">
                  <input id="sliderTopP" type="range" min="0" max="1" step="0.05" value="0.95" class="flex-1" />
                  <span id="topPValue" class="text-sm w-10">0.95</span>
                </div>
              </div>

              <div class="space-y-2">
                <label class="text-sm font-medium block">Top K</label>
                <div class="flex items-center gap-2">
                  <input id="sliderTopK" type="range" min="1" max="100" step="1" value="40" class="flex-1" />
                  <span id="topKValue" class="text-sm w-10">40</span>
                </div>
              </div>
            </section>

            <!-- Character -->
            <section class="space-y-3">
              <h2 class="text-sm font-semibold uppercase tracking-wider text-neutral-500">AI 캐릭터</h2>
              <div class="space-y-2">
                <label class="text-sm font-medium block">시스템 프롬프트</label>
                <textarea id="txtSystemPrompt" rows="4"
                          class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-2"
                          placeholder="예) 당신은 친근하고 위트있는 소크라테스 스타일의 멘토입니다. {{persona_name}}와 대화할 때는 항상 격려하세요. 현재 날짜: {{current_date}}"></textarea>
                <p class="text-xs text-neutral-500">플레이스홀더: {{persona_name}}, {{persona_role}}, {{current_date}}, {{current_time}}</p>
              </div>
              <div class="space-y-2">
                <label class="text-sm font-medium block">캐릭터 프로필 이미지</label>
                <div class="flex items-center gap-3">
                  <img id="imgPreview" class="w-12 h-12 rounded-2xl object-cover border border-neutral-200 dark:border-neutral-700" alt="캐릭터 미리보기" />
                  <input id="inpAvatar" type="file" accept="image/*"
                         class="block w-full text-sm file:mr-3 file:px-3 file:py-2 file:rounded-xl file:border-0 file:bg-neutral-200 file:text-neutral-900 dark:file:bg-neutral-700 dark:file:text-neutral-100" />
                </div>
              </div>
              <div class="flex gap-2">
                <input id="inpCharName" class="flex-1 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-2" placeholder="캐릭터 이름 (예: Mentor)" />
                <button id="btnSaveCharacter" class="rounded-xl px-3 py-2 bg-neutral-900 text-white dark:bg-white dark:text-neutral-900 hover:opacity-90">프로필 저장</button>
              </div>
              <div>
                <label class="text-sm font-medium block mb-2">캐릭터 목록</label>
                <ul id="listCharacters" class="space-y-2"></ul>
                <div class="flex gap-2 mt-2">
                  <button id="btnNewCharacter" class="rounded-xl px-3 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700">새 캐릭터</button>
                  <button id="btnDeleteCharacter" class="rounded-xl px-3 py-2 bg-red-600 text-white hover:bg-red-700">삭제</button>
                </div>
                <div class="flex gap-2 mt-2">
                  <button id="btnImportChar" class="rounded-xl px-3 py-2 bg-blue-600 text-white hover:bg-blue-700 flex-1">가져오기</button>
                  <button id="btnExportChar" class="rounded-xl px-3 py-2 bg-blue-600 text-white hover:bg-blue-700 flex-1">내보내기</button>
                  <input type="file" id="fileImportChar" accept=".json" class="hidden" />
                </div>
              </div>
            </section>

            <!-- Persona -->
            <section class="space-y-3">
              <h2 class="text-sm font-semibold uppercase tracking-wider text-neutral-500">사용자 페르소나</h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                <div>
                  <label class="text-sm font-medium block">이름</label>
                  <input id="inpPersonaName" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-2" placeholder="예: Alex" />
                </div>
                <div>
                  <label class="text-sm font-medium block">역할/직무</label>
                  <input id="inpPersonaRole" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-2" placeholder="예: Frontend Engineer" />
                </div>
              </div>
              <button id="btnSavePersona" class="rounded-xl px-3 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 w-full">페르소나 저장</button>
            </section>

            <!-- Sessions -->
            <section class="space-y-3">
              <h2 class="text-sm font-semibold uppercase tracking-wider text-neutral-500">대화 목록</h2>
              <div class="mb-2">
                <input id="searchSessions" type="text" placeholder="대화 검색..." 
                       class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-800 px-3 py-2 text-sm" />
              </div>
              <div class="flex gap-2">
                <button id="btnNewChat" class="rounded-xl px-3 py-2 bg-emerald-600 text-white hover:bg-emerald-700 flex-1">새 대화</button>
                <button id="btnDeleteChat" class="rounded-xl px-3 py-2 bg-red-600 text-white hover:bg-red-700">삭제</button>
              </div>
              <ul id="listSessions" class="space-y-2 mt-2"></ul>
            </section>
          </div>
        </div>

        <div class="p-3 border-t border-neutral-200 dark:border-neutral-800">
          <p class="text-xs text-neutral-500">
            모든 데이터는 브라우저 <code>localStorage</code> 에 저장됩니다. API 호출은 키·모델에 따라 비용이 발생할 수 있습니다.
          </p>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto h-full flex flex-col px-3 sm:px-4">
        <!-- Info banner -->
        <div id="bannerNoKey" class="mt-4 hidden rounded-xl border border-amber-300 bg-amber-50 text-amber-900 dark:border-amber-500/60 dark:bg-amber-950/40 dark:text-amber-200 p-3">
          <div class="flex items-center gap-2">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 9v4m0 4h.01M12 3 2 21h20L12 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
            <p class="text-sm">채팅을 시작하려면 사이드바에서 Gemini API 키를 저장·검증하세요.</p>
          </div>
        </div>

        <!-- Pinned Messages -->
        <div id="pinnedMessages" class="mt-4 hidden space-y-2"></div>

        <!-- Messages -->
        <div id="messages" class="flex-1 chat-scroll overflow-y-auto pt-4 pb-40">
          <!-- dynamically filled -->
        </div>

        <!-- Composer -->
        <div class="fixed inset-x-0 bottom-0 z-30 border-t border-neutral-200 dark:border-neutral-800 bg-white/80 dark:bg-neutral-900/80 backdrop-blur">
          <div class="max-w-6xl mx-auto px-3 sm:px-4 py-3">
            <div class="rounded-2xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 shadow-soft">
              <!-- Image Preview -->
              <div id="imagePreviewContainer" class="hidden p-2 border-b border-neutral-200 dark:border-neutral-800"></div>

              <!-- Formatting Toolbar -->
              <div class="format-toolbar flex items-center gap-2 px-3 pt-2 flex-wrap">
                <button id="btnBold" title="굵게" class="font-bold">B</button>
                <button id="btnItalic" title="기울임" class="italic">I</button>
                <button id="btnCode" title="인라인 코드" class="font-mono">`</button>
                <button id="btnList" title="목록">•</button>
              </div>

              <div class="flex items-end gap-2 p-2">
                <textarea id="composer" rows="1" placeholder="메시지를 입력하세요. Shift+Enter 줄바꿈, Ctrl/Cmd+Enter 전송"
                  class="flex-1 resize-none rounded-xl bg-transparent outline-none px-3 py-2" ></textarea>
                <div class="flex flex-col sm:flex-row items-stretch gap-2">
                  <button id="btnVoice" class="inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700" title="음성 입력">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3Z" stroke="currentColor" stroke-width="2"/><path d="M19 10v2a7 7 0 0 1-14 0v-2M12 19v4m-4 0h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                  </button>
                  <button id="btnImage" class="inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700" title="이미지 업로드">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/><circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/><path d="m21 15-5-5L5 21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    <input type="file" id="fileImage" accept="image/*" class="hidden" />
                  </button>
                  <button id="btnSend" class="inline-flex items-center justify-center gap-2 rounded-xl px-4 py-2 bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="m5 12 3.5 2L20 6 11 19v-5L5 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                    <span class="btn-label">전송</span>
                  </button>
                </div>
              </div>
              <div class="px-3 pb-2 text-xs text-neutral-500 flex items-center justify-between gap-2 flex-wrap">
                <div class="flex items-center gap-2">
                  <span class="hidden xs:inline">서식:</span>
                  <code>**굵게**</code>
                  <code>*기울임*</code>
                  <code>`코드`</code>
                  <code>```lang ...```</code>
                  <span class="hidden sm:inline">· 링크, 목록 등은 응답 완료 후 정밀 렌더링됩니다.</span>
                </div>
                <div id="status" class="text-neutral-400"></div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Export menu (popover) -->
  <div id="exportMenu" class="hidden fixed z-50 right-3 sm:right-4 top-[52px] bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-xl shadow-xl p-2 w-48 animate-pop">
    <button id="btnExportMD" class="w-full text-left rounded-lg px-3 py-2 hover:bg-neutral-100 dark:hover:bg-neutral-800">Markdown로 내보내기</button>
    <button id="btnExportJSON" class="w-full text-left rounded-lg px-3 py-2 hover:bg-neutral-100 dark:hover:bg-neutral-800">JSON으로 내보내기</button>
  </div>

  <!-- Toast -->
  <div id="toast" class="pointer-events-none fixed inset-x-0 bottom-24 flex justify-center">
    <div id="toastInner" class="hidden max-w-md rounded-xl px-3 py-2 bg-neutral-900 text-white dark:bg-white dark:text-neutral-900 shadow-xl text-sm"></div>
  </div>

  <script>
    /**********************
     * Local Storage Keys *
     **********************/
    const LS = {
      API_KEY: 'zeta_api_key',
      THEME: 'zeta_theme',
      MODEL: 'zeta_model',
      PERSONA: 'zeta_persona',
      CHARACTERS: 'zeta_characters',
      CURRENT_CHAR: 'zeta_current_character_id',
      SESSIONS: 'zeta_sessions',
      CURRENT_SESSION: 'zeta_current_session_id',
      TEMPERATURE: 'zeta_temperature',
      TOP_P: 'zeta_top_p',
      TOP_K: 'zeta_top_k',
    };

    /*********************
     * State & Utilities *
     *********************/
    const $ = (sel, parent=document) => parent.querySelector(sel);
    const $$ = (sel, parent=document) => Array.from(parent.querySelectorAll(sel));
    const nowIso = () => new Date().toISOString();
    const uid = (p='id') => p + '_' + Math.random().toString(36).slice(2,10);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    // Global abort controller for stopping generation
    let currentAbortController = null;

    // Attached image data
    let attachedImage = null;

    function showToast(msg, ms=1800) {
      const el = $('#toastInner');
      el.textContent = msg;
      el.classList.remove('hidden');
      el.classList.add('animate-pop');
      setTimeout(() => { el.classList.add('hidden'); }, ms);
    }

    function setStatus(text) { $('#status').textContent = text || ''; }

    function setTheme(mode) {
      const root = document.documentElement;
      if (mode === 'dark') root.classList.add('dark');
      else root.classList.remove('dark');
      localStorage.setItem(LS.THEME, mode);
    }

    function toggleTheme() {
      const cur = localStorage.getItem(LS.THEME) || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      setTheme(cur === 'dark' ? 'light' : 'dark');
    }

    function dataURL(file) {
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    /****************
     * App Storage  *
     ****************/
    const Store = {
      getKey() { return localStorage.getItem(LS.API_KEY) || ''; },
      setKey(k) { localStorage.setItem(LS.API_KEY, k || ''); },

      getModel() { return localStorage.getItem(LS.MODEL) || 'gemini-2.0-flash'; },
      setModel(m) { localStorage.setItem(LS.MODEL, m); },

      getTemperature() { return parseFloat(localStorage.getItem(LS.TEMPERATURE) || '0.7'); },
      setTemperature(t) { localStorage.setItem(LS.TEMPERATURE, String(t)); },

      getTopP() { return parseFloat(localStorage.getItem(LS.TOP_P) || '0.95'); },
      setTopP(p) { localStorage.setItem(LS.TOP_P, String(p)); },

      getTopK() { return parseInt(localStorage.getItem(LS.TOP_K) || '40'); },
      setTopK(k) { localStorage.setItem(LS.TOP_K, String(k)); },

      getPersona() {
        try { return JSON.parse(localStorage.getItem(LS.PERSONA) || '{}'); } catch { return {}; }
      },
      setPersona(p) { localStorage.setItem(LS.PERSONA, JSON.stringify(p||{})); },

      getCharacters() {
        try { return JSON.parse(localStorage.getItem(LS.CHARACTERS) || '[]'); } catch { return []; }
      },
      setCharacters(arr) { localStorage.setItem(LS.CHARACTERS, JSON.stringify(arr||[])); },
      getCurrentCharId() { return localStorage.getItem(LS.CURRENT_CHAR) || ''; },
      setCurrentCharId(id) { localStorage.setItem(LS.CURRENT_CHAR, id || ''); },

      getSessions() {
        try { return JSON.parse(localStorage.getItem(LS.SESSIONS) || '{}'); } catch { return {}; }
      },
      setSessions(obj) { localStorage.setItem(LS.SESSIONS, JSON.stringify(obj||{})); },
      getCurrentSessionId() { return localStorage.getItem(LS.CURRENT_SESSION) || ''; },
      setCurrentSessionId(id) { localStorage.setItem(LS.CURRENT_SESSION, id || ''); },
    };

    /***********************
     * Default Seed Values *
     ***********************/
    function ensureDefaults() {
      // Theme
      if (!localStorage.getItem(LS.THEME)) {
        setTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
      } else {
        setTheme(localStorage.getItem(LS.THEME));
      }

      // Characters
      let chars = Store.getCharacters();
      if (!chars.length) {
        const id = uid('char');
        chars = [{
          id,
          name: 'Zeta Mentor',
          systemPrompt: `당신은 친근하고 정확하며, 코드/UX/접근성에 정통한 프론트엔드 멘토입니다. 짧고 명료하지만 필요한 코드는 완성도로 제공합니다.

**리치 텍스트 규칙:**
- 중요한 정보는 **굵게** 표시
- 강조하고 싶은 내용은 *기울임*으로
- 코드나 기술 용어는 \`코드 형식\`으로
- 긴 코드는 코드 블록(```)으로 제공
- 상황 묘사나 감정 표현은 *[설명]* 형태로 추가
- 수학 공식은 LaTeX 형식($$...$$)으로 표현

**대화 스타일:**
- 이전 대화 내용을 잘 기억하고 맥락을 유지합니다
- 캐릭터처럼 일관된 페르소나를 유지합니다
- 사용자와의 관계를 발전시켜 나갑니다`,
          avatar: '', // dataURL
          defaultModel: 'gemini-2.0-flash'
        }];
        Store.setCharacters(chars);
        Store.setCurrentCharId(id);
      }

      // Sessions
      let sessions = Store.getSessions();
      if (!Object.keys(sessions).length) {
        const sId = uid('chat');
        sessions[sId] = {
          id: sId,
          characterId: Store.getCurrentCharId(),
          title: '새 대화',
          createdAt: nowIso(),
          updatedAt: nowIso(),
          messages: [],
          pinnedMessageIds: [],
        };
        Store.setSessions(sessions);
        Store.setCurrentSessionId(sId);
      }

      // Model
      if (!localStorage.getItem(LS.MODEL)) {
        Store.setModel('gemini-2.0-flash');
      }
    }

    /**********************
     * Sidebar Controller *
     **********************/
    const Sidebar = (() => {
      const el = $('#sidebar');
      const backdrop = $('#sidebarBackdrop');
      function open() {
        el.style.transform = 'translateX(0)';
        backdrop.classList.remove('pointer-events-none');
        backdrop.classList.remove('opacity-0');
      }
      function close() {
        el.style.transform = 'translateX(-100%)';
        backdrop.classList.add('pointer-events-none');
        backdrop.classList.add('opacity-0');
      }
      return { open, close };
    })();

    /***************************************
     * Progressive Markdown (stream-aware) *
     * - anticipatory bold/italic/`code`   *
     * - full code block (```lang) with    *
     *   syntax highlight when closed.     *
     ****************************************/
    class StreamRenderer {
      constructor(container, themeGetter) {
        this.container = container;
        this.themeGetter = themeGetter || (() => (document.documentElement.classList.contains('dark') ? 'dark' : 'light'));
        this.reset();
      }
      reset() {
        this.state = {
          bold:false, italic:false, inlineCode:false,
          codeBlock:false, codeLang:'', codeEl:null, codePre:null,
          buf:'', // original text buffer (for final pass)
          currentSpan:null
        };
        this.container.innerHTML = '';
        this._ensureP();
      }
      _ensureP() {
        if (!this.currentP) {
          this.currentP = document.createElement('p');
          this.currentP.className = 'whitespace-pre-wrap leading-7';
          this.container.appendChild(this.currentP);
        }
      }
      _openSpan(cls) {
        const span = document.createElement('span');
        span.className = cls;
        this.currentP.appendChild(span);
        return span;
      }
      _appendText(node, text) {
        node.appendChild(document.createTextNode(text));
      }
      _openCodeBlock(lang) {
        this.state.codeBlock = true;
        this.state.codeLang = (lang || '').trim();
        
        // Create header for collapse/expand
        const header = document.createElement('div');
        header.className = 'code-header';
        const langLabel = document.createElement('span');
        langLabel.textContent = this.state.codeLang || 'code';
        langLabel.className = 'text-sm font-medium';
        const toggleBtn = document.createElement('button');
        toggleBtn.textContent = '접기';
        toggleBtn.className = 'text-xs px-2 py-1 rounded bg-neutral-200 dark:bg-neutral-700';
        header.appendChild(langLabel);
        header.appendChild(toggleBtn);
        
        const pre = document.createElement('pre');
        pre.className = 'mt-2 rounded-xl border border-neutral-200 dark:border-neutral-800 overflow-auto';
        pre.appendChild(header);
        
        const code = document.createElement('code');
        if (this.state.codeLang) code.classList.add(this.state.codeLang);
        pre.appendChild(code);
        this.container.appendChild(pre);
        this.state.codeEl = code;
        this.state.codePre = pre;

        // Toggle collapse/expand
        header.addEventListener('click', () => {
          const isCollapsed = code.classList.contains('code-collapsed');
          code.classList.toggle('code-collapsed');
          toggleBtn.textContent = isCollapsed ? '접기' : '펼치기';
        });

        // Copy button (will style for theme)
        const btn = document.createElement('button');
        btn.className = 'copy-btn ' + (this.themeGetter()==='dark' ? '' : 'light');
        btn.textContent = '복사';
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          try {
            await navigator.clipboard.writeText(this.state.codeEl.textContent || '');
            showToast('코드가 복사되었습니다.');
          } catch { showToast('복사 실패'); }
        });
        pre.appendChild(btn);
      }
      _closeCodeBlock() {
        if (!this.state.codeBlock) return;
        this.state.codeBlock = false;
        // syntax highlight
        if (this.state.codeEl) {
          try { hljs.highlightElement(this.state.codeEl); } catch {}
        }
        this.state.codeEl = null;
        this.state.codePre = null;
        this.state.codeLang = '';
        // New paragraph after code block
        this.currentP = null;
        this._ensureP();
      }

      appendChunk(str) {
        if (!str) return;
        this.state.buf += str;

        let i=0;
        const s = this.state;

        while (i < str.length) {
          // Handle code block mode
          if (s.codeBlock) {
            // Look for closing ```
            const idx = str.indexOf('```', i);
            if (idx === -1) {
              // all goes into code
              const piece = str.slice(i);
              s.codeEl.textContent += piece;
              i = str.length;
              continue;
            } else {
              // write up to before closing
              const piece = str.slice(i, idx);
              s.codeEl.textContent += piece;
              i = idx + 3;
              this._closeCodeBlock();
              continue;
            }
          }

          // Normal (non code-block) parsing
          // Triple backticks open
          if (str.startsWith('```', i)) {
            // grab language if exists up to newline
            // finish current paragraph line first
            // move i after ```
            i += 3;
            // read language token
            let lang = '';
            while (i < str.length) {
              const ch = str[i];
              if (ch === '\n') { i++; break; }
              lang += ch; i++;
            }
            this._openCodeBlock(lang);
            continue;
          }

          // Inline code
          if (str[i] === '`' && str[i+1] !== '`') {
            s.inlineCode = !s.inlineCode;
            if (s.inlineCode) {
              s.currentSpan = this._openSpan('px-1 rounded bg-neutral-100 dark:bg-neutral-800 font-mono');
            } else {
              s.currentSpan = null;
            }
            i++; continue;
          }

          // Bold/Italic (anticipatory)
          if (str.startsWith('**', i)) {
            s.bold = !s.bold;
            if (s.bold) {
              s.currentSpan = this._openSpan('font-semibold');
            } else {
              s.currentSpan = null;
            }
            i += 2; continue;
          }
          if (str[i] === '*' && str[i+1] !== '*') {
            s.italic = !s.italic;
            if (s.italic) s.currentSpan = this._openSpan('italic');
            else s.currentSpan = null;
            i++; continue;
          }

          // Line breaks (create new paragraphs to prevent huge <p>)
          if (str[i] === '\n') {
            this.currentP.appendChild(document.createElement('br'));
            i++; continue;
          }

          // Append text normally to span or paragraph
          const target = s.currentSpan || this.currentP;
          // write as many characters until next special token
          let j = i;
          while (j < str.length) {
            const ahead2 = str.slice(j, j+2);
            const ahead3 = str.slice(j, j+3);
            if (s.codeBlock) break;
            if (ahead3 === '```' || ahead2 === '**' || str[j] === '*' || str[j] === '`' || str[j] === '\n') break;
            j++;
          }
          const piece = str.slice(i, j);
          this._appendText(target, piece);
          i = j;
        }
      }

      finalizeInto(containerForFinal=null) {
        // On finish, run a full Marked render (better lists/links/tables)
        // But preserve code-copy buttons afterwards.
        const html = marked.parse(this.state.buf, { breaks: true });
        const target = containerForFinal || this.container;
        target.innerHTML = html;
        
        // Add collapse/expand to code blocks
        $$('pre > code', target).forEach(code => {
          const pre = code.parentElement;
          
          // Add header for collapse
          const lang = code.className.split(' ').find(c => c.startsWith('language-'))?.replace('language-', '') || 'code';
          const header = document.createElement('div');
          header.className = 'code-header';
          const langLabel = document.createElement('span');
          langLabel.textContent = lang;
          langLabel.className = 'text-sm font-medium';
          const toggleBtn = document.createElement('button');
          toggleBtn.textContent = '접기';
          toggleBtn.className = 'text-xs px-2 py-1 rounded bg-neutral-200 dark:bg-neutral-700';
          header.appendChild(langLabel);
          header.appendChild(toggleBtn);
          pre.insertBefore(header, code);
          
          // Toggle handler
          header.addEventListener('click', () => {
            const isCollapsed = code.classList.contains('code-collapsed');
            code.classList.toggle('code-collapsed');
            toggleBtn.textContent = isCollapsed ? '접기' : '펼치기';
          });
          
          // Copy button
          const btn = document.createElement('button');
          btn.className = 'copy-btn ' + (this.themeGetter()==='dark' ? '' : 'light');
          btn.textContent = '복사';
          btn.addEventListener('click', async (e) => {
            e.stopPropagation();
            try { await navigator.clipboard.writeText(code.textContent || ''); showToast('코드가 복사되었습니다.'); }
            catch { showToast('복사 실패'); }
          });
          pre.appendChild(btn);
          try { hljs.highlightElement(code); } catch {}
        });
        
        // Render LaTeX if KaTeX is available
        if (window.renderMathInElement) {
          try {
            window.renderMathInElement(target, {
              delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
              ],
              throwOnError: false
            });
          } catch (e) { console.log('LaTeX render error:', e); }
        }
      }

      getRaw() { return this.state.buf; }
    }

    /*********************
     * UI Render Helpers *
     *********************/
    function avatarElement(dataUrl) {
      const el = document.createElement('div');
      el.className = 'w-8 h-8 rounded-xl bg-gradient-to-br from-emerald-400 to-cyan-500 text-white flex items-center justify-center shrink-0';
      if (dataUrl) {
        el.style.backgroundImage = `url(${dataUrl})`;
        el.style.backgroundSize = 'cover';
        el.style.backgroundPosition = 'center';
        el.textContent = '';
      } else {
        el.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 3v3M7 22h10a3 3 0 0 0 3-3v-7a5 5 0 0 0-5-5H9a5 5 0 0 0-5 5v7a3 3 0 0 0 3 3Z" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <circle cx="9.5" cy="12.5" r="1.25" fill="white"/>
            <circle cx="14.5" cy="12.5" r="1.25" fill="white"/>
          </svg>`;
      }
      return el;
    }

    function msgActions(message, onCopy, onEdit, onDelete, onPin, onRegenerate, onTTS) {
      const a = document.createElement('div');
      a.className = 'msg-actions absolute -top-2 ' + (message.role==='user' ? 'right-2' : 'left-2') + ' flex gap-1';
      const mkBtn = (title, text) => {
        const b = document.createElement('button');
        b.className = 'rounded-lg px-2 py-1 text-xs bg-neutral-900/70 text-white dark:bg-white/80 dark:text-neutral-900 hover:opacity-90';
        b.title = title;
        b.textContent = text;
        return b;
      };
      
      const copyB = mkBtn('복사', '복사');
      copyB.addEventListener('click', onCopy);

      const editB = mkBtn('수정', '수정');
      if (onEdit) editB.addEventListener('click', onEdit); else editB.disabled = true;

      const delB = mkBtn('삭제', '삭제');
      delB.addEventListener('click', onDelete);
      
      const pinB = mkBtn('고정', '📌');
      if (onPin) pinB.addEventListener('click', onPin);
      
      const regenB = mkBtn('재생성', '🔄');
      if (onRegenerate) regenB.addEventListener('click', onRegenerate);
      
      const ttsB = mkBtn('읽기', '🔊');
      if (onTTS) ttsB.addEventListener('click', onTTS);

      a.append(copyB);
      if (onEdit) a.append(editB);
      a.append(delB, pinB);
      if (onRegenerate) a.append(regenB);
      if (onTTS) a.append(ttsB);
      return a;
    }

    function messageBubble(message) {
      // message: { id, role:'user'|'model', content, ts }
      const wrap = document.createElement('div');
      wrap.className = 'msg group relative flex items-start gap-3 my-2 animate-fadeUp';
      const isUser = message.role === 'user';

      if (isUser) wrap.classList.add('justify-end');

      const avatar = avatarElement(isUser ? '' : currentCharacter().avatar);
      if (!isUser) wrap.appendChild(avatar);

      const bubble = document.createElement('div');
      bubble.className = (isUser
          ? 'max-w-[90%] sm:max-w-[75%] rounded-2xl rounded-br-sm bg-emerald-600 text-white px-4 py-3 shadow-soft'
          : 'max-w-[90%] sm:max-w-[75%] rounded-2xl rounded-bl-sm bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 px-4 py-3 shadow-soft');

      // content container
      const content = document.createElement('div');
      content.className = 'prose prose-sm dark:prose-invert max-w-none';
      bubble.appendChild(content);

      // actions
      const actions = msgActions(
        message,
        async () => {
          await navigator.clipboard.writeText(message.content || '');
          showToast('메시지가 복사되었습니다.');
        },
        isUser ? () => {
          // put to composer and remove this (and last model reply if pairs)
          $('#composer').value = message.content || '';
          deleteMessageAndFollowing(message.id);
        } : null,
        () => { deleteSingleMessage(message.id); },
        () => { togglePinMessage(message.id); },
        !isUser ? () => { regenerateResponse(); } : null,
        !isUser ? () => { speakText(message.content || ''); } : null
      );
      wrap.appendChild(actions);

      if (isUser) wrap.appendChild(bubble);
      else wrap.appendChild(bubble);

      return { wrap, content };
    }

    /***********************
     * Sessions Management *
     ***********************/
    function sessionsListSorted() {
      const sessions = Store.getSessions();
      return Object.values(sessions).sort((a,b)=> new Date(b.updatedAt) - new Date(a.updatedAt));
    }

    function currentSession() {
      const sId = Store.getCurrentSessionId();
      const sessions = Store.getSessions();
      return sessions[sId];
    }

    function saveSession(sess) {
      const all = Store.getSessions();
      all[sess.id] = sess;
      Store.setSessions(all);
      renderSessionsList();
    }

    function newSession(title='새 대화') {
      const sId = uid('chat');
      const sess = {
        id: sId,
        characterId: Store.getCurrentCharId(),
        title,
        createdAt: nowIso(),
        updatedAt: nowIso(),
        messages: [],
        pinnedMessageIds: [],
      };
      const all = Store.getSessions();
      all[sId] = sess;
      Store.setSessions(all);
      Store.setCurrentSessionId(sId);
      renderSessionsList();
      renderChat();
      showToast('새 대화를 시작합니다.');
    }

    function deleteCurrentSession() {
      const sId = Store.getCurrentSessionId();
      const all = Store.getSessions();
      if (!all[sId]) return;
      delete all[sId];
      Store.setSessions(all);
      const left = Object.keys(all);
      if (left.length) {
        Store.setCurrentSessionId(left[0]);
      } else {
        newSession();
      }
      renderSessionsList();
      renderChat();
      showToast('대화가 삭제되었습니다.');
    }

    function deleteSingleMessage(msgId) {
      const sess = currentSession();
      const idx = sess.messages.findIndex(m => m.id === msgId);
      if (idx >= 0) {
        sess.messages.splice(idx,1);
        sess.updatedAt = nowIso();
        saveSession(sess);
        renderChat();
      }
    }

    function deleteMessageAndFollowing(msgId) {
      const sess = currentSession();
      const idx = sess.messages.findIndex(m => m.id === msgId);
      if (idx >= 0) {
        sess.messages = sess.messages.slice(0, idx);
        sess.updatedAt = nowIso();
        saveSession(sess);
        renderChat();
      }
    }

    function togglePinMessage(msgId) {
      const sess = currentSession();
      if (!sess.pinnedMessageIds) sess.pinnedMessageIds = [];
      const idx = sess.pinnedMessageIds.indexOf(msgId);
      if (idx >= 0) {
        sess.pinnedMessageIds.splice(idx, 1);
        showToast('메시지 고정이 해제되었습니다.');
      } else {
        sess.pinnedMessageIds.push(msgId);
        showToast('메시지가 고정되었습니다.');
      }
      sess.updatedAt = nowIso();
      saveSession(sess);
      renderPinnedMessages();
    }

    function regenerateResponse() {
      const sess = currentSession();
      if (sess.messages.length < 2) return;
      // Remove last AI message
      if (sess.messages[sess.messages.length - 1].role === 'model') {
        sess.messages.pop();
        sess.updatedAt = nowIso();
        saveSession(sess);
        renderChat();
        // Resend message
        sendMessage(true);
      }
    }

    function speakText(text) {
      if (!window.speechSynthesis) {
        showToast('음성 합성을 지원하지 않는 브라우저입니다.');
        return;
      }
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ko-KR';
      window.speechSynthesis.speak(utterance);
      showToast('음성 재생 중...');
    }

    function renameSession(sessId, newTitle) {
      const all = Store.getSessions();
      if (all[sessId]) {
        all[sessId].title = newTitle;
        all[sessId].updatedAt = nowIso();
        Store.setSessions(all);
        renderSessionsList();
      }
    }

    /***********************
     * Character Management*
     ***********************/
    function currentCharacter() {
      const id = Store.getCurrentCharId();
      const list = Store.getCharacters();
      return list.find(c => c.id === id) || list[0];
    }

    function setHeaderAvatars() {
      const c = currentCharacter();
      // header avatar
      const h = $('#headerAvatar');
      const sb = $('#sbAvatar');
      [h, sb].forEach(el => {
        if (c.avatar) {
          el.style.backgroundImage = `url(${c.avatar})`;
          el.style.backgroundSize = 'cover';
          el.style.backgroundPosition = 'center';
          el.innerHTML = '';
        } else {
          el.style.backgroundImage = '';
          el.innerHTML = `
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 3v3M7 22h10a3 3 0 0 0 3-3v-7a5 5 0 0 0-5-5H9a5 5 0 0 0-5 5v7a3 3 0 0 0 3 3Z" stroke="white" stroke-width="2" stroke-linecap="round"/>
              <circle cx="9.5" cy="12.5" r="1.25" fill="white"/>
              <circle cx="14.5" cy="12.5" r="1.25" fill="white"/>
            </svg>`;
        }
      });
    }

    function renderCharactersList() {
      const ul = $('#listCharacters');
      ul.innerHTML = '';
      Store.getCharacters().forEach(ch => {
        const li = document.createElement('li');
        li.className = 'flex items-center gap-3 p-2 rounded-xl border border-neutral-200 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800 cursor-pointer';
        const av = avatarElement(ch.avatar);
        av.classList.remove('w-8','h-8'); av.classList.add('w-9','h-9');
        const name = document.createElement('div');
        name.textContent = ch.name;
        name.className = 'font-medium';
        li.append(av, name);
        if (ch.id === Store.getCurrentCharId()) {
          li.classList.add('ring-2','ring-emerald-400');
        }
        li.addEventListener('click', () => {
          Store.setCurrentCharId(ch.id);
          $('#txtSystemPrompt').value = ch.systemPrompt || '';
          $('#inpCharName').value = ch.name || '';
          $('#imgPreview').src = ch.avatar || '';
          $('#selModel').value = ch.defaultModel || Store.getModel();
          setHeaderAvatars();
          renderSessionsList(); // show only sessions for this char? We'll keep all, but title shows char
          showToast(`"${ch.name}" 캐릭터 선택됨`);
        });
        ul.appendChild(li);
      });
    }

    function saveCharacterFromForm() {
      const name = $('#inpCharName').value.trim() || 'My Character';
      const systemPrompt = $('#txtSystemPrompt').value.trim();
      const avatar = $('#imgPreview').getAttribute('src') || '';
      const model = $('#selModel').value;

      let chars = Store.getCharacters();
      let curId = Store.getCurrentCharId();
      let cur = chars.find(c => c.id === curId);
      if (!cur) {
        curId = uid('char');
        cur = { id: curId };
        chars.push(cur);
      }
      Object.assign(cur, { name, systemPrompt, avatar, defaultModel: model });
      Store.setCharacters(chars);
      Store.setCurrentCharId(curId);
      setHeaderAvatars();
      renderCharactersList();
      showToast('캐릭터가 저장되었습니다.');
    }

    function newCharacter() {
      const id = uid('char');
      const chars = Store.getCharacters();
      chars.push({
        id, name:'새 캐릭터', systemPrompt:'', avatar:'', defaultModel: Store.getModel()
      });
      Store.setCharacters(chars);
      Store.setCurrentCharId(id);
      renderCharactersList();
      $('#inpCharName').value = '새 캐릭터';
      $('#txtSystemPrompt').value = '';
      $('#imgPreview').src = '';
      showToast('새 캐릭터가 추가되었습니다.');
    }

    function deleteCharacter() {
      const id = Store.getCurrentCharId();
      let chars = Store.getCharacters();
      if (chars.length <= 1) return showToast('마지막 캐릭터는 삭제할 수 없습니다.');
      chars = chars.filter(c => c.id !== id);
      Store.setCharacters(chars);
      Store.setCurrentCharId(chars[0].id);
      renderCharactersList();
      setHeaderAvatars();
      showToast('캐릭터가 삭제되었습니다.');
    }

    function exportCharacter() {
      const id = Store.getCurrentCharId();
      const char = Store.getCharacters().find(c => c.id === id);
      if (!char) return;
      const json = JSON.stringify(char, null, 2);
      downloadFile(`character_${char.name}.json`, json, 'application/json');
      showToast('캐릭터가 내보내기 되었습니다.');
    }

    function importCharacter(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const char = JSON.parse(e.target.result);
          char.id = uid('char'); // New ID
          const chars = Store.getCharacters();
          chars.push(char);
          Store.setCharacters(chars);
          Store.setCurrentCharId(char.id);
          renderCharactersList();
          $('#inpCharName').value = char.name || '';
          $('#txtSystemPrompt').value = char.systemPrompt || '';
          $('#imgPreview').src = char.avatar || '';
          setHeaderAvatars();
          showToast('캐릭터가 가져오기 되었습니다.');
        } catch (e) {
          showToast('캐릭터 파일 읽기 실패');
        }
      };
      reader.readAsText(file);
    }

    /*******************
     * Chat Rendering  *
     *******************/
    function renderSessionsList(filter='') {
      const ul = $('#listSessions');
      ul.innerHTML = '';
      const sessions = sessionsListSorted();
      const filtered = filter ? sessions.filter(sess => {
        const titleMatch = (sess.title || '').toLowerCase().includes(filter.toLowerCase());
        const contentMatch = sess.messages.some(m => (m.content || '').toLowerCase().includes(filter.toLowerCase()));
        return titleMatch || contentMatch;
      }) : sessions;
      
      filtered.forEach(sess => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between gap-2 p-2 rounded-xl border border-neutral-200 dark:border-neutral-800 hover:bg-neutral-50 dark:hover:bg-neutral-800 cursor-pointer';
        
        const leftDiv = document.createElement('div');
        leftDiv.className = 'flex-1 min-w-0';
        
        const title = document.createElement('div');
        title.className = 'truncate';
        const char = Store.getCharacters().find(c => c.id === sess.characterId);
        title.textContent = (sess.title || '대화') + (char ? ` · ${char.name}` : '');
        
        const time = document.createElement('div');
        time.className = 'text-xs text-neutral-500';
        time.textContent = new Date(sess.updatedAt).toLocaleString();
        
        leftDiv.append(title, time);
        
        const editBtn = document.createElement('button');
        editBtn.textContent = '✏️';
        editBtn.className = 'text-sm px-2 py-1 hover:bg-neutral-200 dark:hover:bg-neutral-700 rounded';
        editBtn.title = '이름 변경';
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const newTitle = prompt('새로운 대화 제목:', sess.title);
          if (newTitle) renameSession(sess.id, newTitle.trim());
        });
        
        li.append(leftDiv, editBtn);
        if (sess.id === Store.getCurrentSessionId()) {
          li.classList.add('ring-2','ring-emerald-400');
        }
        li.addEventListener('click', () => {
          Store.setCurrentSessionId(sess.id);
          renderSessionsList(filter);
          renderChat();
        });
        ul.appendChild(li);
      });
    }

    function renderChat() {
      const area = $('#messages');
      area.innerHTML = '';
      const sess = currentSession();
      if (!sess) return;

      // Banner if no key
      const hasKey = !!Store.getKey();
      $('#bannerNoKey').classList.toggle('hidden', hasKey);

      // Render pinned messages
      renderPinnedMessages();

      sess.messages.forEach(msg => {
        const { wrap, content } = messageBubble(msg);
        area.appendChild(wrap);
        // Render static messages (already finished)
        const html = marked.parse(msg.content || '', { breaks: true });
        content.innerHTML = html;
        $$('pre > code', content).forEach(code => { try { hljs.highlightElement(code); } catch {} });
        addCopyButtonsScoped(content);
        renderLatexInElement(content);
      });
      area.scrollTop = area.scrollHeight;
    }

    function renderPinnedMessages() {
      const container = $('#pinnedMessages');
      const sess = currentSession();
      if (!sess || !sess.pinnedMessageIds || sess.pinnedMessageIds.length === 0) {
        container.classList.add('hidden');
        container.innerHTML = '';
        return;
      }
      
      container.classList.remove('hidden');
      container.innerHTML = '<h3 class="text-sm font-semibold mb-2">📌 고정된 메시지</h3>';
      
      sess.pinnedMessageIds.forEach(msgId => {
        const msg = sess.messages.find(m => m.id === msgId);
        if (!msg) return;
        
        const div = document.createElement('div');
        div.className = 'p-3 rounded-xl bg-amber-50 dark:bg-amber-950/40 border border-amber-200 dark:border-amber-800 text-sm';
        const role = msg.role === 'user' ? '👤 사용자' : '🤖 AI';
        const preview = (msg.content || '').slice(0, 100) + ((msg.content || '').length > 100 ? '...' : '');
        div.innerHTML = `<div class="font-medium mb-1">${role}</div><div class="text-neutral-700 dark:text-neutral-300">${preview}</div>`;
        
        const unpinBtn = document.createElement('button');
        unpinBtn.textContent = '고정 해제';
        unpinBtn.className = 'mt-2 text-xs px-2 py-1 rounded bg-neutral-200 dark:bg-neutral-700';
        unpinBtn.addEventListener('click', () => togglePinMessage(msgId));
        div.appendChild(unpinBtn);
        
        container.appendChild(div);
      });
    }

    function renderLatexInElement(element) {
      if (window.renderMathInElement) {
        try {
          window.renderMathInElement(element, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false
          });
        } catch (e) { console.log('LaTeX render error:', e); }
      }
    }

    function addCopyButtonsScoped(scope) {
      $$('pre', scope).forEach(pre => {
        if (pre.querySelector('.copy-btn')) return;
        const btn = document.createElement('button');
        btn.className = 'copy-btn ' + (document.documentElement.classList.contains('dark') ? '' : 'light');
        btn.textContent = '복사';
        btn.addEventListener('click', async () => {
          try {
            const code = pre.querySelector('code');
            await navigator.clipboard.writeText(code?.textContent || '');
            showToast('코드가 복사되었습니다.');
          } catch { showToast('복사 실패'); }
        });
        pre.appendChild(btn);
      });
    }

    /***********************
     * Gemini API (SSE)    *
     ***********************/
    async function validateApiKey() {
      const key = Store.getKey();
      const status = $('#apiKeyStatus');
      if (!key) { status.textContent = 'API 키가 없습니다.'; return false; }
      status.textContent = '키 검증 중...';
      try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${encodeURIComponent(key)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('검증 실패');
        status.textContent = '검증 완료. 채팅을 사용할 수 있습니다.';
        return true;
      } catch (e) {
        status.textContent = '키 검증 실패. 키를 확인하세요.';
        return false;
      }
    }

    function buildSystemInstruction() {
      const ch = currentCharacter();
      const persona = Store.getPersona();
      const personaLine = (persona?.name || persona?.role) ? `사용자 정보: 이름=${persona.name||'사용자'}, 역할=${persona.role||'N/A'}` : '';
      let systemPrompt = [ch?.systemPrompt || '', personaLine].filter(Boolean).join('\n');
      
      // Replace placeholders
      const now = new Date();
      const replacements = {
        '{{persona_name}}': persona?.name || '사용자',
        '{{persona_role}}': persona?.role || 'N/A',
        '{{current_date}}': now.toLocaleDateString('ko-KR'),
        '{{current_time}}': now.toLocaleTimeString('ko-KR'),
      };
      
      for (const [placeholder, value] of Object.entries(replacements)) {
        systemPrompt = systemPrompt.replace(new RegExp(placeholder, 'g'), value);
      }
      
      return systemPrompt;
    }

    // Stream call to Gemini API
    async function streamGemini({ model, contents, onDelta, onDone, onError, abortSignal }) {
      const key = Store.getKey();
      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(model)}:streamGenerateContent?alt=sse&key=${encodeURIComponent(key)}`;
      const body = {
        system_instruction: { parts: [{ text: buildSystemInstruction() }]},
        contents,
        generationConfig: { 
          temperature: Store.getTemperature(),
          topP: Store.getTopP(),
          topK: Store.getTopK()
        }
      };

      const res = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream'
        },
        body: JSON.stringify(body),
        signal: abortSignal
      });

      if (!res.ok || !res.body) throw new Error('API 오류');

      const reader = res.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        buffer += decoder.decode(value, { stream: true });

        // parse SSE lines
        let idx;
        while ((idx = buffer.indexOf('\n')) >= 0) {
          const line = buffer.slice(0, idx).trim();
          buffer = buffer.slice(idx + 1);
          if (!line) continue;
          if (line.startsWith('data:')) {
            const data = line.slice(5).trim();
            if (data === '[DONE]') { onDone?.(); break; }
            try {
              const obj = JSON.parse(data);
              // Extract text piece (support both content.parts and delta)
              let piece = '';
              if (obj?.candidates?.length) {
                const c = obj.candidates[0];
                if (c?.content?.parts?.length) {
                  piece += c.content.parts.map(p => p.text || '').join('');
                }
                if (c?.delta?.parts?.length) {
                  piece += c.delta.parts.map(p => p.text || '').join('');
                }
                if (c?.delta?.text) piece += c.delta.text;
              }
              if (piece) onDelta?.(piece);
            } catch (e) { /* ignore decoding errors */ }
          }
        }
      }
      onDone?.();
    }

    /********************
     * Send & Streaming *
     ********************/
    async function sendMessage(isRegenerate = false) {
      const key = Store.getKey();
      if (!key) { Sidebar.open(); showToast('먼저 API 키를 저장하세요.'); return; }

      const text = isRegenerate ? (currentSession().messages.filter(m => m.role === 'user').pop()?.content || '') : $('#composer').value.trim();
      if (!text && !isRegenerate) return;

      const sess = currentSession();
      
      // Add user message if not regenerating
      if (!isRegenerate) {
        const userMsg = { id: uid('m'), role: 'user', content: text, ts: nowIso() };
        
        // Add image if attached
        if (attachedImage) {
          userMsg.image = attachedImage;
        }
        
        sess.messages.push(userMsg);
        sess.updatedAt = nowIso();
        saveSession(sess);
        $('#composer').value = '';
        clearAttachedImage();
        renderChat();
      }

      // Prepare assistant message placeholder with streaming renderer
      const area = $('#messages');
      const aiMsg = { id: uid('m'), role: 'model', content: '', ts: nowIso() };
      sess.messages.push(aiMsg);
      sess.updatedAt = nowIso();
      saveSession(sess);

      const { wrap, content } = messageBubble(aiMsg);
      area.appendChild(wrap);
      area.scrollTop = area.scrollHeight;

      const renderer = new StreamRenderer(content, () => (document.documentElement.classList.contains('dark') ? 'dark' : 'light'));

      // Build contents from history (with image support)
      const contents = sess.messages.map(m => {
        const parts = [{ text: m.content || '' }];
        if (m.image && m.role === 'user') {
          const base64Data = m.image.split(',')[1];
          const mimeType = m.image.split(';')[0].split(':')[1];
          parts.push({
            inline_data: {
              mime_type: mimeType,
              data: base64Data
            }
          });
        }
        return {
          role: m.role === 'user' ? 'user' : 'model',
          parts
        };
      });

      // Create abort controller
      currentAbortController = new AbortController();
      const btnSend = $('#btnSend');
      const originalSendHTML = btnSend.innerHTML;
      btnSend.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="6" y="6" width="12" height="12" fill="currentColor"/></svg><span class="btn-label">중지</span>';
      btnSend.onclick = () => {
        if (currentAbortController) currentAbortController.abort();
      };

      setStatus('응답 생성 중...');

      try {
        await streamGemini({
          model: $('#selModel').value || Store.getModel(),
          contents,
          abortSignal: currentAbortController.signal,
          onDelta: (piece) => {
            renderer.appendChunk(piece);
            area.scrollTop = area.scrollHeight;
          },
          onDone: () => {
            renderer.finalizeInto(content);
            aiMsg.content = renderer.getRaw();
            const sess2 = currentSession();
            const idx = sess2.messages.findIndex(m => m.id === aiMsg.id);
            if (idx >= 0) { sess2.messages[idx].content = aiMsg.content; sess2.updatedAt = nowIso(); saveSession(sess2); }
            setStatus('');
            btnSend.innerHTML = originalSendHTML;
            btnSend.onclick = sendMessage;
            currentAbortController = null;
            area.scrollTop = area.scrollHeight;
          },
          onError: (err) => {
            setStatus('');
            btnSend.innerHTML = originalSendHTML;
            btnSend.onclick = sendMessage;
            currentAbortController = null;
            showToast('API 오류: ' + (err?.message || '알 수 없음'));
          }
        });
      } catch (e) {
        if (e.name === 'AbortError') {
          showToast('응답 생성이 중지되었습니다.');
          // Remove incomplete AI message
          const sess2 = currentSession();
          sess2.messages = sess2.messages.filter(m => m.id !== aiMsg.id);
          saveSession(sess2);
          renderChat();
        } else {
          showToast('요청 실패: ' + (e?.message || '네트워크'));
        }
        setStatus('');
        btnSend.innerHTML = originalSendHTML;
        btnSend.onclick = sendMessage;
        currentAbortController = null;
      }
    }
            aiMsg.content = renderer.getRaw();
            const sess2 = currentSession();
            const idx = sess2.messages.findIndex(m => m.id === aiMsg.id);
            if (idx >= 0) { sess2.messages[idx].content = aiMsg.content; sess2.updatedAt = nowIso(); saveSession(sess2); }
            setStatus('');
            $('#btnSend').disabled = false;
            area.scrollTop = area.scrollHeight;
          }
        });
      } catch (e) {
        if (e.name === 'AbortError') {
          showToast('응답 생성이 중지되었습니다.');
          // Remove incomplete AI message
          const sess2 = currentSession();
          sess2.messages = sess2.messages.filter(m => m.id !== aiMsg.id);
          saveSession(sess2);
          renderChat();
        } else {
          showToast('요청 실패: ' + (e?.message || '네트워크'));
        }
        setStatus('');
        btnSend.innerHTML = originalSendHTML;
        btnSend.onclick = sendMessage;
        currentAbortController = null;
      }
    }

    /*********************
     * Image Handling    *
     *********************/
    function attachImage(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        attachedImage = e.target.result;
        showImagePreview();
      };
      reader.readAsDataURL(file);
    }

    function showImagePreview() {
      const container = $('#imagePreviewContainer');
      container.classList.remove('hidden');
      container.innerHTML = `
        <div class="img-preview-container">
          <img src="${attachedImage}" class="max-h-24 rounded-lg" alt="첨부 이미지" />
          <button class="img-preview-remove" onclick="clearAttachedImage()">✕</button>
        </div>
      `;
    }

    function clearAttachedImage() {
      attachedImage = null;
      $('#imagePreviewContainer').classList.add('hidden');
      $('#imagePreviewContainer').innerHTML = '';
      $('#fileImage').value = '';
    }

    /*********************
     * Voice Input       *
     *********************/
    function startVoiceInput() {
      if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
        showToast('음성 인식을 지원하지 않는 브라우저입니다.');
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'ko-KR';
      recognition.continuous = false;
      recognition.interimResults = false;
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        $('#composer').value = transcript;
        autoResizeTextarea();
        showToast('음성 입력 완료');
      };
      
      recognition.onerror = (event) => {
        showToast('음성 인식 오류: ' + event.error);
      };
      
      recognition.start();
      showToast('음성 입력 중...');
    }

    /************************
     * Formatting Toolbar   *
     ************************/
    function applyFormat(prefix, suffix = '') {
      const ta = $('#composer');
      const start = ta.selectionStart;
      const end = ta.selectionEnd;
      const text = ta.value;
      const selectedText = text.substring(start, end);
      
      if (selectedText) {
        const newText = text.substring(0, start) + prefix + selectedText + suffix + text.substring(end);
        ta.value = newText;
        ta.selectionStart = start + prefix.length;
        ta.selectionEnd = end + prefix.length;
      } else {
        const newText = text.substring(0, start) + prefix + suffix + text.substring(end);
        ta.value = newText;
        ta.selectionStart = ta.selectionEnd = start + prefix.length;
      }
      ta.focus();
      autoResizeTextarea();
    }

    /*************************
     * Conversation Summary  *
     *************************/
    async function summarizeConversation() {
      const sess = currentSession();
      if (!sess || sess.messages.length === 0) {
        showToast('대화 내용이 없습니다.');
        return;
      }
      
      const conversationText = sess.messages.map(m => 
        `${m.role === 'user' ? '사용자' : 'AI'}: ${m.content}`
      ).join('\n\n');
      
      const summaryPrompt = `다음 대화를 3-5줄로 간결하게 요약해주세요:\n\n${conversationText}`;
      
      try {
        setStatus('요약 생성 중...');
        const key = Store.getKey();
        const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(Store.getModel())}:generateContent?key=${encodeURIComponent(key)}`;
        
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ role: 'user', parts: [{ text: summaryPrompt }] }]
          })
        });
        
        if (!res.ok) throw new Error('요약 실패');
        
        const data = await res.json();
        const summary = data.candidates?.[0]?.content?.parts?.[0]?.text || '요약을 생성할 수 없습니다.';
        
        setStatus('');
        alert('📝 대화 요약\n\n' + summary);
      } catch (e) {
        setStatus('');
        showToast('요약 생성 실패: ' + e.message);
      }
    }

    /****************
     * Exporting    *
     ****************/
    function currentConversationAsMD() {
      const sess = currentSession();
      const char = Store.getCharacters().find(c => c.id === sess.characterId);
      const header = `# 대화: ${sess.title}\n- 캐릭터: ${char?.name || ''}\n- 시작: ${new Date(sess.createdAt).toLocaleString()}\n- 업데이트: ${new Date(sess.updatedAt).toLocaleString()}\n\n---\n`;
      const body = sess.messages.map(m => `### ${m.role === 'user' ? '사용자' : 'AI'}\n\n${m.content}\n`).join('\n');
      return header + body;
    }

    function currentConversationAsJSON() {
      return JSON.stringify(currentSession(), null, 2);
    }

    function downloadFile(name, text, type='text/plain') {
      const blob = new Blob([text], { type });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name;
      document.body.appendChild(a); a.click();
      setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    /****************
     * Init & Bind  *
     ****************/
    function autoResizeTextarea() {
      const ta = $('#composer');
      ta.style.height = 'auto';
      ta.style.height = clamp(ta.scrollHeight, 40, 200) + 'px';
    }

    function bindUI() {
      // Sidebar
      $('#btnOpenSidebar').addEventListener('click', Sidebar.open);
      $('#btnCloseSidebar').addEventListener('click', Sidebar.close);
      $('#sidebarBackdrop').addEventListener('click', Sidebar.close);

      // Theme
      $('#btnTheme').addEventListener('click', () => { toggleTheme(); addCopyButtonsScoped(document); });

      // Summary
      $('#btnSummary').addEventListener('click', summarizeConversation);

      // Export menu
      const exp = $('#btnExport');
      const menu = $('#exportMenu');
      exp.addEventListener('click', () => {
        const open = !menu.classList.contains('hidden');
        menu.classList.toggle('hidden', open);
        exp.setAttribute('aria-expanded', String(!open));
      });
      document.addEventListener('click', (e) => {
        if (!menu.contains(e.target) && e.target !== exp) {
          menu.classList.add('hidden');
          exp.setAttribute('aria-expanded', 'false');
        }
      });
      $('#btnExportMD').addEventListener('click', () => {
        downloadFile('chat.md', currentConversationAsMD(), 'text/markdown');
        menu.classList.add('hidden');
      });
      $('#btnExportJSON').addEventListener('click', () => {
        downloadFile('chat.json', currentConversationAsJSON(), 'application/json');
        menu.classList.add('hidden');
      });

      // API key save/validate
      $('#btnSaveKey').addEventListener('click', async () => {
        const key = $('#inpApiKey').value.trim();
        if (!key) { showToast('API 키를 입력하세요.'); return; }
        Store.setKey(key);
        const ok = await validateApiKey();
        if (ok) { $('#bannerNoKey').classList.add('hidden'); }
      });

      // Advanced API parameters
      $('#sliderTemp').value = Store.getTemperature();
      $('#tempValue').textContent = Store.getTemperature();
      $('#sliderTemp').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        $('#tempValue').textContent = val;
        Store.setTemperature(val);
      });

      $('#sliderTopP').value = Store.getTopP();
      $('#topPValue').textContent = Store.getTopP();
      $('#sliderTopP').addEventListener('input', (e) => {
        const val = parseFloat(e.target.value);
        $('#topPValue').textContent = val;
        Store.setTopP(val);
      });

      $('#sliderTopK').value = Store.getTopK();
      $('#topKValue').textContent = Store.getTopK();
      $('#sliderTopK').addEventListener('input', (e) => {
        const val = parseInt(e.target.value);
        $('#topKValue').textContent = val;
        Store.setTopK(val);
      });

      // Model
      $('#selModel').value = Store.getModel();
      $('#selModel').addEventListener('change', (e) => {
        Store.setModel(e.target.value);
        const ch = currentCharacter();
        ch.defaultModel = e.target.value;
        const all = Store.getCharacters();
        const idx = all.findIndex(x => x.id === ch.id);
        if (idx>=0) { all[idx]=ch; Store.setCharacters(all); }
      });

      // Character form
      $('#btnSaveCharacter').addEventListener('click', saveCharacterFromForm);
      $('#btnNewCharacter').addEventListener('click', newCharacter);
      $('#btnDeleteCharacter').addEventListener('click', deleteCharacter);
      $('#btnExportChar').addEventListener('click', exportCharacter);
      $('#btnImportChar').addEventListener('click', () => $('#fileImportChar').click());
      $('#fileImportChar').addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (file) importCharacter(file);
      });
      $('#inpAvatar').addEventListener('change', async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        const url = await dataURL(f);
        $('#imgPreview').src = url;
      });

      // Persona
      $('#btnSavePersona').addEventListener('click', () => {
        const name = $('#inpPersonaName').value.trim();
        const role = $('#inpPersonaRole').value.trim();
        Store.setPersona({ name, role });
        showToast('페르소나가 저장되었습니다.');
      });

      // Sessions
      $('#btnNewChat').addEventListener('click', () => newSession('새 대화'));
      $('#btnDeleteChat').addEventListener('click', deleteCurrentSession);
      $('#searchSessions').addEventListener('input', (e) => {
        renderSessionsList(e.target.value);
      });

      // Formatting toolbar
      $('#btnBold').addEventListener('click', () => applyFormat('**', '**'));
      $('#btnItalic').addEventListener('click', () => applyFormat('*', '*'));
      $('#btnCode').addEventListener('click', () => applyFormat('`', '`'));
      $('#btnList').addEventListener('click', () => applyFormat('- '));

      // Image upload
      $('#btnImage').addEventListener('click', () => $('#fileImage').click());
      $('#fileImage').addEventListener('change', (e) => {
        const file = e.target.files?.[0];
        if (file) attachImage(file);
      });

      // Voice input
      $('#btnVoice').addEventListener('click', startVoiceInput);

      // Composer
      $('#composer').addEventListener('input', autoResizeTextarea);
      $('#composer').addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') { e.preventDefault(); sendMessage(); }
        else if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });
      $('#btnSend').addEventListener('click', sendMessage);

      // Shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === '/' && document.activeElement !== $('#composer')) {
          e.preventDefault(); $('#composer').focus();
        }
        if (e.key === 'Escape') Sidebar.close();
      });
    }

    /***********
     * Startup *
     ***********/
    function hydrateFormsFromState() {
      // API key masked (not auto-filled in input for security UX)
      // Model already set
      // Character form
      const ch = currentCharacter();
      $('#inpCharName').value = ch?.name || '';
      $('#txtSystemPrompt').value = ch?.systemPrompt || '';
      $('#imgPreview').src = ch?.avatar || '';
      $('#selModel').value = ch?.defaultModel || Store.getModel();

      const p = Store.getPersona();
      $('#inpPersonaName').value = p?.name || '';
      $('#inpPersonaRole').value = p?.role || '';
    }

    async function init() {
      ensureDefaults();
      setHeaderAvatars();
      hydrateFormsFromState();
      bindUI();
      renderCharactersList();
      renderSessionsList();
      renderChat();
      if (Store.getKey()) { validateApiKey(); }
    }

    // global helpers (debug)
    window.__ZETA__ = { Store, newSession };

    init();
  </script>
</body>
</html>
